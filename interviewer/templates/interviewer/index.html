<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mock Interviewer</title>
    <style>
        :root {
            --bg: #f3f5f8;
            --panel: #0d2238;
            --panel-soft: #173959;
            --card: #ffffff;
            --accent: #1261a8;
            --text: #162433;
            --muted: #607080;
            --border: #d9e1ea;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: "Segoe UI", Tahoma, sans-serif;
            color: var(--text);
            background: linear-gradient(160deg, #eef2f6 0%, #f9fbfd 100%);
        }

        .layout {
            min-height: 100vh;
            display: flex;
        }

        .sidebar {
            width: 300px;
            background: linear-gradient(180deg, var(--panel) 0%, var(--panel-soft) 100%);
            color: #ecf4ff;
            padding: 22px 18px;
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        .sidebar h1 {
            font-size: 22px;
            margin: 0;
        }

        .side-note {
            margin: 0;
            color: #c2d6ed;
            font-size: 14px;
            line-height: 1.45;
        }

        .side-btn {
            border: 1px solid #91b4d6;
            background: transparent;
            color: #eef6ff;
            border-radius: 10px;
            padding: 10px 12px;
            font-weight: 700;
            cursor: pointer;
            text-align: left;
        }

        .side-btn.primary {
            background: #f0f6ff;
            color: #0f2e4b;
            border-color: #f0f6ff;
        }

        .main {
            flex: 1;
            padding: 22px;
        }

        .card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 20px;
            box-shadow: 0 14px 28px rgba(30, 60, 90, 0.08);
        }

        .meta {
            margin: 0 0 16px;
            color: var(--muted);
        }

        #progress {
            margin-bottom: 12px;
            color: #2d4358;
            font-weight: 600;
        }

        .question-box {
            background: #f7fbff;
            border: 1px solid #d8e6f5;
            border-left: 5px solid var(--accent);
            border-radius: 10px;
            padding: 14px;
            margin-bottom: 14px;
        }

        .topic-chip {
            display: inline-block;
            font-size: 12px;
            font-weight: 700;
            margin-bottom: 8px;
            padding: 4px 8px;
            border-radius: 999px;
            background: #deecfb;
            color: #0f4f90;
        }

        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 12px;
        }

        button {
            border: none;
            border-radius: 9px;
            padding: 10px 14px;
            cursor: pointer;
            font-weight: 700;
        }

        .primary {
            background: var(--accent);
            color: #fff;
        }

        .secondary {
            background: #dde9f7;
            color: #133b62;
        }

        button:disabled {
            opacity: 0.55;
            cursor: not-allowed;
        }

        textarea {
            width: 100%;
            min-height: 140px;
            border: 1px solid #c9d7e6;
            border-radius: 10px;
            padding: 11px;
            font-size: 15px;
            resize: vertical;
        }

        .panel {
            margin-top: 16px;
            border: 1px solid #e2e8ef;
            border-radius: 10px;
            background: #fafcff;
            padding: 12px;
        }

        .panel h3 {
            margin: 0 0 8px;
            font-size: 16px;
        }

        .panel ul {
            margin: 8px 0 0;
            padding-left: 18px;
        }

        .panel li {
            margin-bottom: 6px;
            color: #27445f;
        }

        @media (max-width: 900px) {
            .layout {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
            }
        }
    </style>
</head>
<body>
<div class="layout">
    <aside class="sidebar">
        <h1>Mock Interviewer</h1>
        <p class="side-note">Question bank: {{ question_bank_size }} questions<br>Interview run: {{ total_questions }} questions</p>
        <button id="startBtn" class="side-btn primary">Start Interview</button>
        <button id="historyBtn" class="side-btn">View Past Scores & Feedback</button>
        <p class="side-note">Topics covered: {{ topics }}</p>
    </aside>

    <main class="main">
        <div class="card">
            <div id="progress">Press "Start Interview" to begin.</div>

            <div class="question-box">
                <div id="topic" class="topic-chip">-</div>
                <div id="question">Question will appear here.</div>
            </div>

            <div class="controls">
                <button class="secondary" id="speakBtn" disabled>Speak Question</button>
                <button class="secondary" id="recordBtn" disabled>Start Voice Input</button>
                <button class="primary" id="submitBtn" disabled>Submit Answer</button>
            </div>

            <textarea id="answer" placeholder="Type or dictate your answer..."></textarea>

            <div id="report" class="panel" style="display:none"></div>
        </div>
    </main>
</div>

<script>
    const startBtn = document.getElementById("startBtn");
    const historyBtn = document.getElementById("historyBtn");
    const speakBtn = document.getElementById("speakBtn");
    const recordBtn = document.getElementById("recordBtn");
    const submitBtn = document.getElementById("submitBtn");
    const answerBox = document.getElementById("answer");
    const questionEl = document.getElementById("question");
    const topicEl = document.getElementById("topic");
    const progressEl = document.getElementById("progress");
    const reportEl = document.getElementById("report");

    let currentQuestion = null;
    let recognition = null;
    let totalQuestions = 25;

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (SpeechRecognition) {
        recognition = new SpeechRecognition();
        recognition.lang = "en-US";
        recognition.interimResults = false;
        recognition.maxAlternatives = 1;
        recognition.onresult = (event) => {
            answerBox.value = event.results[0][0].transcript;
        };
        recognition.onerror = () => {
            progressEl.textContent = "Voice capture failed. You can type your answer.";
            recordBtn.textContent = "Start Voice Input";
        };
        recognition.onend = () => {
            recordBtn.textContent = "Start Voice Input";
        };
    } else {
        recordBtn.disabled = true;
    }

    function speak(text) {
        if (!window.speechSynthesis || !text) return;
        const utterance = new SpeechSynthesisUtterance(text);
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(utterance);
    }

    function renderFinalReport(report) {
        const topicRows = Object.entries(report.topic_breakdown)
            .map(([topic, info]) => `<li><strong>${topic}</strong>: score ${info.average}/10 across ${info.count} question(s). Feedback: ${info.feedback}</li>`)
            .join("");

        reportEl.innerHTML = `
            <h3>Final Interview Report</h3>
            <div><strong>Overall Score:</strong> ${report.overall_score}/10</div>
            <div><strong>Overall Feedback:</strong> ${report.overall_feedback}</div>
            <ul>${topicRows}</ul>
        `;
        reportEl.style.display = "block";
    }

    function showQuestion(payload) {
        currentQuestion = payload.question;
        totalQuestions = payload.total_questions || totalQuestions;
        questionEl.textContent = currentQuestion.prompt;
        topicEl.textContent = currentQuestion.topic;
        progressEl.textContent = `Question ${payload.question_index} of ${totalQuestions}`;
        answerBox.value = "";
        speakBtn.disabled = false;
        recordBtn.disabled = !recognition;
        submitBtn.disabled = false;
    }

    startBtn.addEventListener("click", async () => {
        try {
            const res = await fetch("/api/start/");
            if (!res.ok) throw new Error(`Start failed (${res.status})`);
            const data = await res.json();
            reportEl.style.display = "none";
            showQuestion(data);
            speak(data.question.prompt);
        } catch (error) {
            progressEl.textContent = `Unable to start interview: ${error.message}`;
        }
    });

    historyBtn.addEventListener("click", () => {
        window.location.href = "/past-scores/";
    });

    speakBtn.addEventListener("click", () => {
        if (currentQuestion) speak(currentQuestion.prompt);
    });

    recordBtn.addEventListener("click", () => {
        if (!recognition) return;
        recordBtn.textContent = "Listening...";
        recognition.start();
    });

    submitBtn.addEventListener("click", async () => {
        try {
            const answer = answerBox.value.trim();
            const res = await fetch("/api/answer/", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ answer }),
            });
            if (!res.ok) throw new Error(`Submit failed (${res.status})`);

            const data = await res.json();
            if (data.finished) {
                submitBtn.disabled = true;
                speakBtn.disabled = true;
                recordBtn.disabled = true;
                progressEl.textContent = "Interview finished. Final feedback is now available.";
                renderFinalReport(data.report);
                speak(`Interview completed. Your overall score is ${data.report.overall_score} out of ten.`);
                return;
            }

            showQuestion(data);
        } catch (error) {
            progressEl.textContent = `Unable to submit answer: ${error.message}`;
        }
    });
</script>
</body>
</html>
