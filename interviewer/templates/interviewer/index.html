<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interview Console</title>
    <style>
        :root {
            --primary-blue: #60a5fa;
            --positive-green: #22c55e;
            --warning-amber: #f59e0b;
            --grid-light: #334155;
            --bg-dark: #0b1220;
            --text-indigo: #e2e8f0;
            --surface: #111827;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            font-family: "Segoe UI", Tahoma, sans-serif;
            background: var(--bg-dark);
            color: var(--text-indigo);
            line-height: 1.55;
        }

        .wrap {
            max-width: 1040px;
            margin: 0 auto;
            padding: 40px 24px 56px;
        }

        .head {
            display: flex;
            justify-content: space-between;
            gap: 16px;
            align-items: flex-start;
            margin-bottom: 28px;
        }

        .title {
            margin: 0;
            font-size: 34px;
            line-height: 1.15;
            font-family: Georgia, "Times New Roman", serif;
            letter-spacing: 0.2px;
        }

        .sub {
            margin: 10px 0 0;
            font-size: 15px;
            color: var(--text-indigo);
            opacity: 0.86;
        }

        .badge {
            border: 1px solid var(--grid-light);
            background: var(--surface);
            color: var(--text-indigo);
            border-radius: 8px;
            padding: 10px 14px;
            font-size: 12px;
            font-weight: 700;
            white-space: nowrap;
            box-shadow: 0 2px 8px rgba(2, 6, 23, 0.4);
        }

        .card {
            border: 1px solid var(--grid-light);
            border-radius: 8px;
            background: var(--surface);
            padding: 24px;
            box-shadow: 0 4px 14px rgba(2, 6, 23, 0.45);
        }

        .row {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 14px;
            align-items: center;
            margin-bottom: 16px;
        }

        .btn-link {
            display: inline-block;
            text-decoration: none;
            border-radius: 8px;
            border: 1px solid var(--primary-blue);
            background: var(--primary-blue);
            color: #0b1220;
            padding: 10px 14px;
            font-weight: 700;
            box-shadow: 0 2px 6px rgba(96, 165, 250, 0.26);
        }

        .progress {
            font-weight: 700;
            margin: 0 0 12px;
            color: var(--text-indigo);
        }

        .question {
            border: 1px solid var(--grid-light);
            border-radius: 8px;
            background: #0f172a;
            padding: 16px;
            margin-bottom: 14px;
            min-height: 108px;
        }

        .topic {
            display: inline-block;
            border-radius: 8px;
            background: var(--primary-blue);
            color: #0b1220;
            padding: 4px 10px;
            font-size: 12px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(2, minmax(120px, 1fr));
            gap: 10px;
            margin-bottom: 14px;
        }

        button {
            border: 1px solid var(--primary-blue);
            border-radius: 8px;
            padding: 11px;
            font-weight: 700;
            cursor: pointer;
            background: var(--primary-blue);
            color: #0b1220;
            box-shadow: 0 2px 6px rgba(96, 165, 250, 0.24);
        }

        button.secondary {
            background: transparent;
            color: var(--primary-blue);
        }

        button:disabled {
            opacity: 0.58;
            cursor: not-allowed;
            box-shadow: none;
        }

        textarea {
            width: 100%;
            min-height: 170px;
            border-radius: 8px;
            border: 1px solid var(--grid-light);
            background: #0f172a;
            color: var(--text-indigo);
            padding: 12px;
            resize: vertical;
            font-size: 14px;
            margin-bottom: 14px;
        }

        .report {
            display: none;
            border: 1px solid var(--grid-light);
            border-radius: 8px;
            background: #0f172a;
            padding: 14px;
        }

        @media (max-width: 760px) {
            .wrap {
                padding: 28px 16px 36px;
            }

            .head {
                flex-direction: column;
                margin-bottom: 20px;
            }

            .row {
                grid-template-columns: 1fr;
            }

            .controls {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
<div class="wrap">
    <div class="head">
        <div>
            <h1 class="title">Interview Console</h1>
            <p class="sub">No accounts required. Each question is asked in voice automatically before you can submit an answer.</p>
        </div>
        <div class="badge">Question Bank: {{ question_bank_size }} | Topics: {{ topics }}</div>
    </div>

    <section class="card">
        <div class="row">
            <p class="sub">Run length: {{ total_questions }} questions.</p>
            <a class="btn-link" href="/past-scores/">Open Dashboard</a>
        </div>

        <div id="progress" class="progress">Press "Start Interview" to begin.</div>

        <div class="question">
            <div id="topic" class="topic">-</div>
            <div id="question">Question will appear here.</div>
        </div>

        <div class="controls">
            <button id="startBtn">Start Interview</button>
            <button id="recordBtn" class="secondary" disabled>Voice Input</button>
        </div>

        <textarea id="answer" placeholder="Type or dictate your answer..."></textarea>
        <button id="submitBtn" disabled>Submit Answer</button>

        <div id="report" class="report"></div>
    </section>
</div>

<script>
    const STORAGE_KEY = "mock_interview_attempts_v1";

    const startBtn = document.getElementById("startBtn");
    const recordBtn = document.getElementById("recordBtn");
    const submitBtn = document.getElementById("submitBtn");
    const answerBox = document.getElementById("answer");
    const questionEl = document.getElementById("question");
    const topicEl = document.getElementById("topic");
    const progressEl = document.getElementById("progress");
    const reportEl = document.getElementById("report");

    let currentQuestion = null;
    let recognition = null;
    let totalQuestions = 25;
    let questionAudioPlayed = false;

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (SpeechRecognition) {
        recognition = new SpeechRecognition();
        recognition.lang = "en-US";
        recognition.interimResults = false;
        recognition.maxAlternatives = 1;
        recognition.onresult = (event) => {
            answerBox.value = event.results[0][0].transcript;
        };
        recognition.onerror = () => {
            progressEl.textContent = "Voice capture failed. You can type your answer.";
            recordBtn.textContent = "Voice Input";
        };
        recognition.onend = () => {
            recordBtn.textContent = "Voice Input";
        };
    }

    function getCookie(name) {
        const cookieValue = `; ${document.cookie}`;
        const parts = cookieValue.split(`; ${name}=`);
        if (parts.length === 2) {
            return parts.pop().split(";").shift();
        }
        return "";
    }

    function speakMandatory(text) {
        return new Promise((resolve, reject) => {
            if (!window.speechSynthesis || !text) {
                reject(new Error("Speech synthesis is unavailable. Voice question is mandatory."));
                return;
            }

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.onend = () => resolve();
            utterance.onerror = () => reject(new Error("Unable to play question audio."));
            window.speechSynthesis.cancel();
            window.speechSynthesis.speak(utterance);
        });
    }

    function safeFixed(value, digits = 2) {
        return Number(value || 0).toFixed(digits);
    }

    function loadAttempts() {
        try {
            const raw = localStorage.getItem(STORAGE_KEY);
            if (!raw) return [];
            const parsed = JSON.parse(raw);
            return Array.isArray(parsed) ? parsed : [];
        } catch {
            return [];
        }
    }

    function saveAttempt(report) {
        const attempts = loadAttempts();
        attempts.unshift({
            completed_at: new Date().toISOString(),
            report,
        });
        localStorage.setItem(STORAGE_KEY, JSON.stringify(attempts.slice(0, 100)));
    }

    function renderFinalReport(report) {
        const topicRows = Object.entries(report.topic_breakdown)
            .map(([topic, info]) => `<li><strong>${topic}</strong>: score ${safeFixed(info.average)} / 10. Feedback: ${info.feedback}</li>`)
            .join("");

        reportEl.innerHTML = `
            <h3>Final Interview Report</h3>
            <div><strong>Overall Score:</strong> ${safeFixed(report.overall_score)} / 10</div>
            <div><strong>Overall Feedback:</strong> ${report.overall_feedback}</div>
            <ul>${topicRows}</ul>
        `;
        reportEl.style.display = "block";
    }

    function showQuestion(payload) {
        currentQuestion = payload.question;
        totalQuestions = payload.total_questions || totalQuestions;
        questionAudioPlayed = false;
        questionEl.textContent = currentQuestion.prompt;
        topicEl.textContent = currentQuestion.topic;
        progressEl.textContent = `Question ${payload.question_index} of ${totalQuestions} (voice required)`;
        answerBox.value = "";
        recordBtn.disabled = !recognition;
        submitBtn.disabled = true;

        speakMandatory(currentQuestion.prompt)
            .then(() => {
                questionAudioPlayed = true;
                progressEl.textContent = `Question ${payload.question_index} of ${totalQuestions}`;
                submitBtn.disabled = false;
            })
            .catch((error) => {
                progressEl.textContent = error.message;
                submitBtn.disabled = true;
            });
    }

    startBtn.addEventListener("click", async () => {
        try {
            const res = await fetch("/api/start/");
            if (!res.ok) throw new Error(`Start failed (${res.status})`);
            const data = await res.json();
            reportEl.style.display = "none";
            showQuestion(data);
        } catch (error) {
            progressEl.textContent = `Unable to start interview: ${error.message}`;
        }
    });

    recordBtn.addEventListener("click", () => {
        if (!recognition) return;
        recordBtn.textContent = "Listening...";
        recognition.start();
    });

    submitBtn.addEventListener("click", async () => {
        try {
            if (!questionAudioPlayed) {
                progressEl.textContent = "You must hear the question audio before submitting.";
                return;
            }

            const answer = answerBox.value.trim();
            const csrfToken = getCookie("csrftoken");
            const res = await fetch("/api/answer/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": csrfToken,
                },
                body: JSON.stringify({ answer }),
            });
            if (!res.ok) throw new Error(`Submit failed (${res.status})`);

            const data = await res.json();
            if (data.finished) {
                submitBtn.disabled = true;
                recordBtn.disabled = true;
                progressEl.textContent = "Interview finished. Report saved in your browser.";
                renderFinalReport(data.report);
                saveAttempt(data.report);
                return;
            }

            showQuestion(data);
        } catch (error) {
            progressEl.textContent = `Unable to submit answer: ${error.message}`;
        }
    });
</script>
</body>
</html>
